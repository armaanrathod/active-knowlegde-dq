<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AcaDeBot - Enhanced Debate System</title>
  <style>
    body {
      font-family: "Times New Roman", serif;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
      position: relative;
      text-align: center;
      background-image: url("WhatsApp Image 2025-09-24 at 17.33.10 (1).jpeg");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .light-mode {
      color: #000;
    }
    .dark-mode {
      color: #f1f1f1;
    }

    /* Glass frame */
    .frame {
      display: inline-block;
      margin-top: 120px;  
      padding: 20px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      transition: all 0.3s;
      position: relative;
      z-index: 2;
    }
    .frame.active {
      margin-top: 10px;
      padding: 10px;
      border: none;
      background: none;
      box-shadow: none;
    }
    .dark-mode .frame {
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Glass textarea */
    textarea {
      width: 500px;
      height: 200px;
      font-size: 16px;
      margin-top: 20px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: inherit;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      resize: none;
    }
    .dark-mode textarea {
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #f1f1f1;
    }

    /* Glass button */
    button {
      font-size: 16px;
      margin: 10px;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: inherit;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, background 0.3s;
    }
    button:hover {
      transform: scale(1.05);
      background: rgba(255, 255, 255, 0.3);
    }
    .dark-mode button {
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #f1f1f1;
    }

    /* Theme panel glass */
    #theme-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 10px;
      border-radius: 12px;
      font-size: 14px;
      z-index: 3;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* Debate Section */
    #debate-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin-top: 80px;
      gap: 20px;
      display: none;
    }
    #person-left, #person-right {
      width: 120px;
      height: 250px;
      background-size: cover;
      background-position: center;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    /* Glass script box */
    #script-box {
      width: 600px;
      height: 400px;
      border-radius: 12px;
      padding: 15px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: inherit;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-align: left;
      font-size: 14px;
      line-height: 1.5;
    }
    .dark-mode #script-box {
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #f1f1f1;
    }

    /* Questions section */
    #questions-container {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 12px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .dark-mode #questions-container {
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .question {
      margin: 15px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      text-align: left;
    }

    .question-response {
      margin-top: 10px;
    }

    .question-response button {
      margin: 5px;
      padding: 8px 16px;
      font-size: 14px;
    }

    /* Status display */
    #status-display {
      margin-top: 20px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-weight: bold;
    }

    /* Side selection */
    #side-selection {
      display: none;
      margin-top: 20px;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>
<body class="light-mode">
  <!-- Theme Switch Panel -->
  <div id="theme-panel">
    <div>Theme:</div>
    <button id="theme-toggle">ðŸŒž Light</button>
  </div>

  <!-- Content inside frame -->
  <div class="frame" id="main-frame">
    <textarea id="article" placeholder="Paste your article here..."></textarea>
    <br>
    <!-- PDF upload -->
    <input type="file" id="pdf-upload" accept=".pdf">
    <div id="pdf-name"></div>
    <!-- Generate Debate button -->
    <br>
    <button id="generate-btn">Start Enhanced Debate</button>
    
    <div id="status-display" style="display: none;"></div>
  </div>

  <!-- Debate Section -->
  <div id="debate-container">
    <div id="person-left" style="background-image:url('person1.jpg');"></div>
    <div id="script-box">
      <div id="debate-content">Enhanced debate will appear here...</div>
    </div>
    <div id="person-right" style="background-image:url('person2.jpg');"></div>
  </div>

  <!-- Questions Section -->
  <div id="questions-container">
    <h3>Engagement Questions</h3>
    <div id="questions-list"></div>
    <div id="side-selection">
      <h4>Which side would you like to explore further?</h4>
      <button id="continue-for">Continue with FOR arguments</button>
      <button id="continue-against">Continue with AGAINST arguments</button>
    </div>
    <button id="submit-responses" style="display: none;">Continue Debate</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.102/pdf.min.js"></script>
  <script>
    const API_BASE = 'http://localhost:5001';
    let currentSessionId = 'default';
    let currentRound = 1;
    let questionResponses = [];
    let selectedSide = 'For';

    const pdfUpload = document.getElementById("pdf-upload");
    const textarea = document.getElementById("article");
    const pdfName = document.getElementById("pdf-name");
    const themeToggle = document.getElementById("theme-toggle");
    const body = document.body;

    const generateBtn = document.getElementById("generate-btn");
    const mainFrame = document.getElementById("main-frame");
    const debateContainer = document.getElementById("debate-container");
    const debateContent = document.getElementById("debate-content");
    const questionsContainer = document.getElementById("questions-container");
    const questionsList = document.getElementById("questions-list");
    const statusDisplay = document.getElementById("status-display");
    const sideSelection = document.getElementById("side-selection");
    const submitResponses = document.getElementById("submit-responses");

    // PDF upload logic (same as before)
    pdfUpload.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (file) {
        pdfName.textContent = `Uploaded: ${file.name}`;
        const fileReader = new FileReader();
        fileReader.onload = async function() {
          const typedarray = new Uint8Array(this.result);
          const pdf = await pdfjsLib.getDocument(typedarray).promise;
          let textContent = "";
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const text = await page.getTextContent();
            text.items.forEach(item => {
              textContent += item.str + " ";
            });
            textContent += "\n\n";
          }
          textarea.value = textContent;
        };
        fileReader.readAsArrayBuffer(file);
      }
    });

    // Theme toggle (same as before)
    themeToggle.addEventListener("click", () => {
      if (body.classList.contains("light-mode")) {
        body.classList.remove("light-mode");
        body.classList.add("dark-mode");
        themeToggle.textContent = "ðŸŒ™ Dark";
      } else {
        body.classList.remove("dark-mode");
        body.classList.add("light-mode");
        themeToggle.textContent = "ðŸŒž Light";
      }
    });

    // Start enhanced debate
    generateBtn.addEventListener("click", async () => {
      const article = textarea.value.trim();
      if (!article) {
        alert("Please enter an article first!");
        return;
      }

      showStatus("Starting enhanced debate...");
      generateBtn.classList.add("loading");

      try {
        const response = await fetch(`${API_BASE}/start_debate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            article: article,
            session_id: currentSessionId
          })
        });

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        displayInitialPoints(data.initial_points);
        showDebateContainer();
        await generateQuestions();

      } catch (error) {
        showStatus(`Error: ${error.message}`);
      } finally {
        generateBtn.classList.remove("loading");
      }
    });

    async function generateQuestions() {
      try {
        const response = await fetch(`${API_BASE}/generate_questions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: currentSessionId })
        });

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        displayQuestions(data.questions);
      } catch (error) {
        showStatus(`Error generating questions: ${error.message}`);
      }
    }

    function displayInitialPoints(points) {
      debateContent.innerHTML = `
        <h3>Initial Debate Points (Round ${currentRound})</h3>
        <pre style="white-space: pre-wrap; font-family: inherit;">${points}</pre>
      `;
    }

    function displayQuestions(questions) {
      const questionLines = questions.split('\n').filter(line => line.trim() && /^\d+\./.test(line.trim()));
      questionsList.innerHTML = '';
      questionResponses = [];

      questionLines.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';
        questionDiv.innerHTML = `
          <div><strong>${question}</strong></div>
          <div class="question-response">
            <button onclick="recordResponse(${index}, 'yes')" data-response="no">Yes</button>
            <button onclick="recordResponse(${index}, 'no')" data-response="no">No</button>
          </div>
        `;
        questionsList.appendChild(questionDiv);
        questionResponses.push(null);
      });

      questionsContainer.style.display = 'block';
    }

    function recordResponse(questionIndex, response) {
      questionResponses[questionIndex] = response;
      
      // Update button states
      const questionDiv = questionsList.children[questionIndex];
      const buttons = questionDiv.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase() === response) {
          btn.style.background = 'rgba(0, 255, 0, 0.3)';
        } else {
          btn.style.background = '';
        }
      });

      // Check if all questions answered
      if (questionResponses.every(resp => resp !== null)) {
        sideSelection.style.display = 'block';
      }
    }

    // Side selection handlers
    document.getElementById('continue-for').addEventListener('click', () => {
      selectedSide = 'For';
      document.getElementById('continue-for').style.background = 'rgba(0, 255, 0, 0.3)';
      document.getElementById('continue-against').style.background = '';
      submitResponses.style.display = 'block';
    });

    document.getElementById('continue-against').addEventListener('click', () => {
      selectedSide = 'Against';
      document.getElementById('continue-against').style.background = 'rgba(0, 255, 0, 0.3)';
      document.getElementById('continue-for').style.background = '';
      submitResponses.style.display = 'block';
    });

    // Continue debate
    submitResponses.addEventListener('click', async () => {
      showStatus("Generating continuation...");
      submitResponses.classList.add("loading");

      try {
        const response = await fetch(`${API_BASE}/continue_debate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: currentSessionId,
            side: selectedSide,
            user_responses: questionResponses
          })
        });

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        if (data.session_ended) {
          showStatus(data.message);
          questionsContainer.style.display = 'none';
          if (data.final_points) {
            debateContent.innerHTML += `
              <h3>Final Points</h3>
              <pre style="white-space: pre-wrap; font-family: inherit;">${data.final_points}</pre>
            `;
          }
          return;
        }

        // Display new points
        currentRound = data.round;
        debateContent.innerHTML += `
          <h3>Round ${currentRound} (${selectedSide} Arguments)</h3>
          <pre style="white-space: pre-wrap; font-family: inherit;">${data.new_points}</pre>
        `;

        if (data.relevance_scores && data.relevance_scores.length > 0) {
          const avgRelevance = data.relevance_scores.reduce((a, b) => a + b, 0) / data.relevance_scores.length;
          showStatus(`Average relevance: ${avgRelevance.toFixed(1)}%`);
        }

        // Generate new questions for next round
        await generateQuestions();

      } catch (error) {
        showStatus(`Error: ${error.message}`);
      } finally {
        submitResponses.classList.remove("loading");
      }
    });

    function showDebateContainer() {
      pdfUpload.style.display = "none";
      textarea.style.display = "none";
      pdfName.style.display = "none";
      generateBtn.style.display = "none";
      mainFrame.classList.add("active");
      debateContainer.style.display = "flex";
    }

    function showStatus(message) {
      statusDisplay.textContent = message;
      statusDisplay.style.display = 'block';
      setTimeout(() => {
        statusDisplay.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>